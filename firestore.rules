/**
 * @file Firebase Security Rules for Firestore.
 * @description This ruleset enforces a strict user-ownership model for personal data while allowing public read access to level definitions.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the authenticated user can read/write their own profile.
 * - /levels/{levelId}: Stores level definitions. This collection is intended to be publicly readable, but write access is not defined in the current rules.
 * - /users/{userId}/userTasks/{userTaskId}: Stores user-specific task assignments. Only the authenticated user can read/write their own tasks.
 * - /users/{userId}/streaks/{streakId}: Stores user's streak data. Only the authenticated user can read/write their own streak data.
 * - /users/{userId}/redemptions/{redemptionId}: Stores redemption records. Only the authenticated user can read/write their own redemption data.
 * - /users/{userId}/mealPlans/{mealPlanId}: Stores meal plans. Only the authenticated user can read/write their own meal plans.
 *
 * Key Security Decisions:
 * - User data is isolated under their respective UID.
 * - User listing is explicitly denied.
 * - Read-only collections (e.g., levels) are explicitly defined.
 *
 * Denormalization for Authorization:
 * - All user-owned documents are nested under /users/{userId} to allow for simple path-based authorization using the `isOwner()` function.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the authenticated user's ID matches the provided userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the authenticated user's ID matches the owner ID of an existing resource.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }
    
    /**
     * @description Defines security rules for user profiles.
     * @path /users/{userId}
     * @allow (create) Authenticated user creates their own profile with matching UID.
     * @deny (create) Unauthenticated user attempts to create a profile.
     * @allow (get) Authenticated user reads their own profile.
     * @deny (get) Authenticated user attempts to read another user's profile.
     * @allow (update) Authenticated user updates their own profile.
     * @deny (update) Authenticated user attempts to update another user's profile.
     * @allow (delete) Authenticated user deletes their own profile.
     * @deny (delete) Authenticated user attempts to delete another user's profile.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow get: if isOwner(userId);
      allow list: if false;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for level definitions.
     * @path /levels/{levelId}
     * @allow (get) Any user can read level definitions.
     * @deny (create) No user can create level definitions via client.
     * @deny (update) No user can update level definitions via client.
     * @deny (delete) No user can delete level definitions via client.
     * @principle Allows public read access. Write access is restricted.
     */
    match /levels/{levelId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Defines security rules for user tasks.
     * @path /users/{userId}/userTasks/{userTaskId}
     * @allow (create) Authenticated user creates a task under their profile.
     * @deny (create) Unauthenticated user attempts to create a task.
     * @allow (get) Authenticated user reads their own task.
     * @deny (get) Authenticated user attempts to read another user's task.
     * @allow (update) Authenticated user updates their own task.
     * @deny (update) Authenticated user attempts to update another user's task.
     * @allow (delete) Authenticated user deletes their own task.
     * @deny (delete) Authenticated user attempts to delete another user's task.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/userTasks/{userTaskId} {
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get, list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for user streaks.
     * @path /users/{userId}/streaks/{streakId}
     * @allow (create) Authenticated user creates a streak under their profile.
     * @deny (create) Unauthenticated user attempts to create a streak.
     * @allow (get) Authenticated user reads their own streak.
     * @deny (get) Authenticated user attempts to read another user's streak.
     * @allow (update) Authenticated user updates their own streak.
     * @deny (update) Authenticated user attempts to update another user's streak.
     * @allow (delete) Authenticated user deletes their own streak.
     * @deny (delete) Authenticated user attempts to delete another user's streak.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/streaks/{streakId} {
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get, list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for user redemptions.
     * @path /users/{userId}/redemptions/{redemptionId}
     * @allow (create) Authenticated user creates a redemption under their profile.
     * @deny (create) Unauthenticated user attempts to create a redemption.
     * @allow (get) Authenticated user reads their own redemption.
     * @deny (get) Authenticated user attempts to read another user's redemption.
     * @allow (update) Authenticated user updates their own redemption.
     * @deny (update) Authenticated user attempts to update another user's redemption.
     * @allow (delete) Authenticated user deletes their own redemption.
     * @deny (delete) Authenticated user attempts to delete another user's redemption.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/redemptions/{redemptionId} {
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get, list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Defines security rules for user meal plans.
     * @path /users/{userId}/mealPlans/{mealPlanId}
     * @allow (create) Authenticated user creates a meal plan under their profile.
     * @deny (create) Unauthenticated user attempts to create a meal plan.
     * @allow (get) Authenticated user reads their own meal plan.
     * @deny (get) Authenticated user attempts to read another user's meal plan.
     * @allow (update) Authenticated user updates their own meal plan.
     * @deny (update) Authenticated user attempts to update another user's meal plan.
     * @allow (delete) Authenticated user deletes their own meal plan.
     * @deny (delete) Authenticated user attempts to delete another user's meal plan.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId}/mealPlans/{mealPlanId} {
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow get, list: if isOwner(userId);
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }
  }
}